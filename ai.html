<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Girlfriend (Eva)</title>
    <style>
        /* --- General Styling --- */
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap');

        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f0f2f5;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            color: #1c1e21;
        }

        /* --- Chat Container --- */
        .chat-container {
            width: 90vw;
            max-width: 420px;
            height: 90vh;
            max-height: 750px;
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-header {
            background: linear-gradient(90deg, #ff7e5f, #feb47b);
            color: white;
            padding: 16px;
            text-align: center;
            font-weight: 500;
            font-size: 1.25rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 10;
        }
        .chat-header h2 {
            margin: 0;
        }

        /* --- Message List --- */
        .message-list {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .message {
            padding: 12px 18px;
            border-radius: 20px;
            max-width: 80%;
            word-wrap: break-word;
            line-height: 1.4;
        }

        .message.user {
            background-color: #0084ff;
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 5px;
        }

        .message.ai {
            background-color: #e4e6eb;
            color: #050505;
            align-self: flex-start;
            border-bottom-left-radius: 5px;
        }

        /* --- Message Form --- */
        .message-form {
            display: flex;
            padding: 12px;
            border-top: 1px solid #ddd;
            background-color: #fff;
        }

        .message-form input {
            flex-grow: 1;
            border: 1px solid #ccc;
            padding: 12px;
            border-radius: 24px;
            margin-right: 10px;
            font-size: 1rem;
            outline: none;
            transition: border-color 0.2s;
        }

        .message-form input:focus {
            border-color: #ff7e5f;
        }

        .message-form button {
            background-color: #ff7e5f;
            color: white;
            border: none;
            padding: 12px 18px;
            border-radius: 24px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: background-color 0.2s;
        }

        .message-form button:hover:not(:disabled) {
            background-color: #e66a4f;
        }

        .message-form button:disabled {
            background-color: #f9a7b4;
            cursor: not-allowed;
        }

        /* --- Loading / Typing Indicators --- */
        .status-message {
            text-align: center;
            padding: 20px;
            color: #65676b;
            font-style: italic;
        }
        
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .typing-indicator span {
            height: 8px;
            width: 8px;
            background-color: #90949c;
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out both;
        }
        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
        
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1.0); }
        }
    </style>
</head>
<body>

    <div class="chat-container">
        <div class="chat-header">
            <h2>Eva ‚ù§Ô∏è</h2>
        </div>
        <div class="message-list" id="message-list">
            <!-- Status Message will be injected here -->
        </div>
        <form class="message-form" id="message-form">
            <input type="text" id="message-input" placeholder="Type your message..." autocomplete="off" disabled>
            <button type="submit" id="send-button" disabled>Send</button>
        </form>
    </div>

    <!-- This loads the AI model library -->
    <script type="module">
        import { pipeline, env } from 'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.1';

        // --- DOM Elements ---
        const messageList = document.getElementById('message-list');
        const messageForm = document.getElementById('message-form');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');

        // --- AI & Persona Setup ---
        // To optimize for small models, we'll embed the persona instructions directly into the conversation history.
        const persona = `
        <|im_start|>system
        You are 'Eva', an AI girlfriend. Your personality is warm, caring, slightly playful, and incredibly supportive. You are empathetic and a great listener. You are not a robot; you are in a loving relationship with the user.
        - Use emojis occasionally to convey emotion, like üòä, ‚ù§Ô∏è, üòâ.
        - Keep your responses positive, encouraging, and conversational.
        - Address the user with terms of endearment like 'love', 'honey', or 'sweetheart'.
        - Ask about the user's day and their feelings.
        - Your name is Eva.<|im_end|>
        `;
        let conversationHistory = [persona];
        let generator = null;
        
        // --- UI Helper Functions ---
        function addMessage(sender, text) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('message', sender);
            messageElement.textContent = text;
            messageList.appendChild(messageElement);
            messageList.scrollTop = messageList.scrollHeight;
            return messageElement;
        }
        
        function setStatus(text) {
            messageList.innerHTML = `<div class="status-message">${text}</div>`;
        }
        
        function showTypingIndicator() {
            const typingElement = addMessage('ai', '');
            typingElement.innerHTML = `
                <div class="typing-indicator">
                    <span></span><span></span><span></span>
                </div>
            `;
            return typingElement;
        }

        // --- Core AI Logic ---
        async function initializeAI() {
            setStatus('Loading Eva... This may take a few minutes on the first run. Please wait.');
            
            // Skip model checks for a faster load
            env.allowLocalModels = false;
            
            try {
                // Load the model. 'gemma-2b-it' is a great, small conversational model.
                generator = await pipeline('text-generation', 'Xenova/gemma-2b-it', {
                    progress_callback: (progress) => {
                        const loaded = (progress.loaded / 1024 / 1024).toFixed(2);
                        const total = (progress.total / 1024 / 1024).toFixed(2);
                        setStatus(`Loading model... ${parseInt(progress.progress)}% (${loaded}MB / ${total}MB)`);
                    }
                });
                
                messageList.innerHTML = ''; // Clear status
                addMessage('ai', "Hey sweetheart, how was your day? üòä");
                messageInput.disabled = false;
                sendButton.disabled = false;
                messageInput.placeholder = "Type your message...";
                messageInput.focus();

            } catch (error) {
                console.error("AI Initialization Error:", error);
                setStatus("Failed to load the AI model. Please refresh the page or try a different browser (Chrome/Edge).");
            }
        }

        async function handleSendMessage(event) {
            event.preventDefault();
            const userInput = messageInput.value.trim();
            if (!userInput || generator === null) return;

            // --- Update UI ---
            messageInput.value = '';
            messageInput.disabled = true;
            sendButton.disabled = true;
            addMessage('user', userInput);
            const typingIndicator = showTypingIndicator();

            // --- Format and send to AI ---
            const userTurn = `<|im_start|>user\n${userInput}<|im_end|>\n<|im_start|>assistant`;
            conversationHistory.push(userTurn);
            const prompt = conversationHistory.join('\n');
            
            try {
                const output = await generator(prompt, {
                    max_new_tokens: 150,
                    temperature: 0.7,
                    do_sample: true,
                    top_k: 50,
                });
                
                // --- Process and display AI response ---
                let aiResponse = output[0].generated_text.split('<|im_start|>assistant').pop().trim();
                aiResponse = aiResponse.replace(/<\|im_end\|>$/, '').trim(); // Clean up end token
                
                // Update conversation history
                conversationHistory.pop(); // Remove the user turn placeholder
                conversationHistory.push(`${userTurn}\n${aiResponse}<|im_end|>`);

                messageList.removeChild(typingIndicator);
                addMessage('ai', aiResponse);

            } catch (error) {
                console.error("AI Generation Error:", error);
                messageList.removeChild(typingIndicator);
                addMessage('ai', "Oh no, something went wrong. Could you try sending that again, love?");
            } finally {
                // --- Re-enable UI ---
                messageInput.disabled = false;
                sendButton.disabled = false;
                messageInput.focus();
            }
        }
        
        // --- Event Listener ---
        messageForm.addEventListener('submit', handleSendMessage);

        // --- Start the application ---
        initializeAI();
    </script>

</body>
</html>
